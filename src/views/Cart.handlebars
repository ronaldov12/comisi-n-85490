<h1>Carrito de Compras</h1>

<a href="/">Volver al inicio ğŸ </a>

{{#if cart.products.length}}
<ul>
    {{#each cart.products}}
    <li>
        <strong>{{this.product.title}}</strong> â€“ Precio: ${{this.product.price}} â€“ Cantidad: {{this.quantity}}

        <!-- botones para modificar cantidad -->
        <button onclick="cambiarCantidad('{{../cart._id}}', '{{this.product._id}}', {{this.quantity}} - 1)" {{#if (lte this.quantity 1)}}disabled{{/if}}>-</button>
        <button onclick="cambiarCantidad('{{../cart._id}}', '{{this.product._id}}', {{this.quantity}} + 1)">+</button>

        <!-- boton para eliminar producto -->
        <button onclick="eliminarProducto('{{../cart._id}}', '{{this.product._id}}')">Eliminar</button>
    </li>
    {{/each}}
</ul>

<!-- boton para finalizar compra -->
<button onclick="finalizarCompra('{{cart._id}}')">Finalizar compra ğŸ›’</button>

{{else}}
<p>El carrito estÃ¡ vacÃ­o.</p>
{{/if}}

<script>
    async function cambiarCantidad(cartId, productId, nuevaCantidad) {
        if (nuevaCantidad < 1) return;

        try {
            const res = await fetch(`/api/carts/${cartId}/products/${productId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantity: nuevaCantidad })
            });

            if (res.ok) location.reload();
            else alert('Error al actualizar la cantidad');
        } catch (err) {
            alert('Error de conexiÃ³n con el servidor');
            console.error(err);
        }
    }

    async function eliminarProducto(cartId, productId) {
        try {
            const res = await fetch(`/api/carts/${cartId}/products/${productId}`, {
                method: 'DELETE'
            });

            if (res.ok) location.reload();
            else alert('Error al eliminar el producto');
        } catch (err) {
            alert('Error de conexiÃ³n con el servidor');
            console.error(err);
        }
    }

    async function finalizarCompra(cartId) {
        const confirmar = confirm('Â¿EstÃ¡s seguro de que quieres finalizar la compra? ğŸ›ï¸');
        if (!confirmar) return;

        try {
            const res = await fetch(`/api/carts/${cartId}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                alert('Â¡Compra realizada con Ã©xito!');
                location.reload();
            } else {
                alert('Error al finalizar la compra');
            }
        } catch (err) {
            alert('Error de conexiÃ³n con el servidor');
            console.error(err);
        }
    }
</script>
